<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Song Request</title>

    <link href="https://cdn.jsdelivr.net/npm/halfmoon@1.1.1/css/halfmoon-variables.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/halfmoon@1.1.1/js/halfmoon.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://kit.fontawesome.com/7854e7e538.js" crossorigin="anonymous"></script>

    <script src="tmi.js"></script>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const client = new tmi.Client({
            channels: [ urlParams.get('streamer') ]
        });

        client.connect(); 
    </script>
 
</head>
<body class="dark-mode">
    <div class="container">
        <h1 style="text-align: center;">Song request</h1>
        <p style="text-align: center;">Clique em "Coletar pedidos" para criar a playlist</p>
        <div id="player" style="margin: 0 auto; text-align: center; display: none;"></div>
        <div id="info" style="display: none;">
            <h4 style="text-align: center;"></h4>
            <div id="buttons" style="text-align: center; width: 100%;">
                <button class="btn" onclick="anterior()">Música anterior</button>
                <button class="btn" onclick="proxima()">Pular Música</button>
            </div>
        </div>
        <div id="pedidos" style="text-align: center; max-height: 300px; overflow-y: auto;"></div>
        <div id="buttons" style="text-align: center; width: 100%;">
            <button class="btn" onclick="start = true; $('#coletar').hide(); $('p').text('esperando pedidos...')" id="coletar">Coletar pedidos</button>
            <!-- <button class="btn" onclick="play_pl()" id="pl" style="display: none;">Tocar playlist coletada</button> -->
        </div>
    </div>



    <footer style="text-align: center;">
        Criado por: <a href="https://github.com/Viniciuuz" target="_blank">Viniciuuz</a>
    </footer>

    <script>
        var start = false

        const tag = document.createElement("script");
        tag.id = "iframe-demo";
        tag.src = "https://www.youtube.com/iframe_api";
        const [firstScriptTag] = document.getElementsByTagName("script");
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        let player;

        window.onPlayerReady = (event) => {
            event.target.playVideo();
        };

        window.onPlayerStateChange = (event) => {
            if (event.data === 0) {
                proxima()                
            }
        };

        window.onYouTubeIframeAPIReady = () => {
            player = new window.YT.Player("player", {
                width: '100%',
                height: 480,
                videoId: "",
                events: {
                    onReady: window.onPlayerReady,
                    onStateChange: window.onPlayerStateChange
                }
            });
        };

        function youtube_parser(url){
            if(url.startsWith('https://www.youtube.com/watch?v=')){
                return url.split('=')[1]
            }else if(url.startsWith('https://youtu.be/')){
                return url.split('/')[3]
            }
        }

        var pedidos = []
        var pedido = 0
        var first = true
        
        client.on('message', (channel, tags, message, self) => {
            if(message.startsWith('!sr') && start == true){
                console.log(message.replace('!sr ', ''))
                pedidos.push({'name': tags['display-name'], 'color': tags.color, 'message': youtube_parser(message.replace('!sr ', ''))})
                if(first == true){
                    first = false
                    player.loadVideoById(pedidos[0].message)
                    play_pl()
                }
            }
            console.log(`${tags['display-name']}: ${message}`)
            
        });

        function play_pl(){
            $('p').text('F5 para criar uma nova playlist')
            
            $('#pl').hide()
            $('#info').show()
            $('#info h4').html(`Pedido por: <span style="color: ${pedidos[0].color};">${pedidos[0].name}</span>`)
            $('#player').show()
            $('#info').show()
            $('#pedidos').hide()

        }

        function proxima(){
            if(pedido + 1 > pedidos.length - 1){

            }else{
                pedido++
                player.loadVideoById(pedidos[pedido].message)
            }
        }

        function anterior(){
            if(pedido - 1 < 0){

            }else{
                pedido--
                player.loadVideoById(pedidos[pedido].message)
            }
        }

    </script>
</body>
</html>